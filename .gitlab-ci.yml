stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HUB_IMAGE: "$DOCKER_HUB_USERNAME/task-manager"
  DOCKER_TAG: "latest"

before_script:
  - echo "Pipeline starting..."

# -------------------------
# 1) BUILD & PUSH TO DOCKER HUB
# -------------------------
build_app:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to Docker Hub (skipped if creds missing)..."
    - |
      if [ -n "$DOCKER_HUB_USERNAME" ] && [ -n "$DOCKER_HUB_PASSWORD" ]; then
        echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
        echo "Building Docker image..."
        docker build -t "$DOCKER_HUB_IMAGE:$DOCKER_TAG" .
        echo "Pushing image to Docker Hub..."
        docker push "$DOCKER_HUB_IMAGE:$DOCKER_TAG"
        echo "Success - Image pushed to Docker Hub"
      else
        echo "Docker Hub credentials not set; skipping build/push but marking job as success."
      fi
  only:
    - develop
    - main
  allow_failure: true

# -------------------------
# 2) RUN TESTS
# -------------------------
test_app:
  stage: test
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Running tests..."
    - npm test
    - echo "Tests completed"
  artifacts:
    expire_in: 1 week
    paths:
      - coverage/
  only:
    - merge_requests
    - develop
  allow_failure: true

# -------------------------
# 3) DEPLOY TO RAILWAY
# -------------------------
deploy_railway:
  stage: deploy
  image: node:18
  before_script:
    - curl -fsSL https://railway.app/install.sh | sh
    - export PATH="/root/.railway/bin:$PATH"
  script:
    - |
        set -e
        echo "Deploying to Railway..."
        echo "npm prefix: $(npm config get prefix)"
        ls -l /usr/local/bin | head -n 20
        which railway
        railway --version
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "Missing RAILWAY_TOKEN in CI variables"; exit 1; fi
        if [ -z "$RAILWAY_PROJECT_ID" ]; then
          echo "Missing RAILWAY_PROJECT_ID in CI variables"; exit 1; fi
        export RAILWAY_TOKEN="$RAILWAY_TOKEN"
        echo "Authenticating with Railway token (masked)..."
        railway status --json || echo "railway status: unable to fetch (will continue)"
        echo "Linking project $RAILWAY_PROJECT_ID..."
        railway link --project "$RAILWAY_PROJECT_ID" --key "$RAILWAY_TOKEN"
        echo "Deploying..."
        railway up --detach
        echo "Deployment to Railway completed successfully"
        echo "If custom domain: set it in Railway dashboard (default *.up.railway.app)"
  only:
    - main
  when: manual
  allow_failure: false
