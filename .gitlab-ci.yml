stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HUB_IMAGE: "$DOCKER_HUB_USERNAME/task-manager"
  DOCKER_TAG: "latest"

before_script:
  - echo "Pipeline starting..."

# -------------------------
# 1) BUILD & PUSH TO DOCKER HUB
# -------------------------
build_app:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to Docker Hub..."
    - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin
    - echo "Building Docker image..."
    - docker build -t $DOCKER_HUB_IMAGE:$DOCKER_TAG .
    - echo "Pushing image to Docker Hub..."
    - docker push $DOCKER_HUB_IMAGE:$DOCKER_TAG
    - echo "Success - Image pushed to Docker Hub"
  only:
    - develop
    - main
  allow_failure: true

# -------------------------
# 2) RUN TESTS
# -------------------------
test_app:
  stage: test
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Running tests..."
    - npm test
    - echo "Tests completed"
  artifacts:
    expire_in: 1 week
    paths:
      - coverage/
  only:
    - merge_requests
    - develop
  allow_failure: true

# -------------------------
# 3) DEPLOY TO RAILWAY
# -------------------------
deploy_railway:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Triggering Railway deployment..."
    - |
      if [ -n "$RAILWAY_WEBHOOK_URL" ]; then
        curl -X POST $RAILWAY_WEBHOOK_URL
        echo "Railway deployment triggered successfully"
      else
        echo "Railway webhook not configured"
        echo "To enable: Set RAILWAY_WEBHOOK_URL in GitLab CI/CD Variables"
      fi
  environment:
    name: production
    url: https://your-app.railway.app
  only:
    - main
    - develop
  when: manual
  allow_failure: true
