stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HUB_IMAGE: "$DOCKER_HUB_USERNAME/task-manager"
  DOCKER_TAG: "latest"
  NODE_ENV: "production"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

before_script:
  - echo "Pipeline starting... Commit: $CI_COMMIT_SHORT_SHA"

# -------------------------
# 1) BUILD & PUSH TO DOCKER HUB
# -------------------------
build_app:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to Docker Hub (skipped if creds missing)..."
    - |
      if [ -n "$DOCKER_HUB_USERNAME" ] && [ -n "$DOCKER_HUB_PASSWORD" ]; then
        echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
        echo "Building Docker image..."
        docker build -t "$DOCKER_HUB_IMAGE:$DOCKER_TAG" .
        echo "Pushing image to Docker Hub..."
        docker push "$DOCKER_HUB_IMAGE:$DOCKER_TAG"
        echo "Success - Image pushed to Docker Hub"
      else
        echo "Docker Hub credentials not set; skipping build/push but marking job as success."
      fi
  only:
    - develop
    - main
  allow_failure: true

# -------------------------
# 2) RUN TESTS
# -------------------------
test_app:
  stage: test
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Running tests..."
    - npm test
    - echo "Tests completed"
  artifacts:
    expire_in: 1 week
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  only:
    - merge_requests
    - develop
    - main
  allow_failure: true

# -------------------------
# 3) TRIGGER VERCEL DEPLOY HOOK
# -------------------------
deploy_vercel:
  stage: deploy
  image: curlimages/curl:8.6.0
  script:
    - |
        set -e
        if [ -z "$VERCEL_DEPLOY_HOOK" ]; then
          echo "Missing VERCEL_DEPLOY_HOOK CI variable"; exit 1; fi
        echo "Triggering Vercel deploy hook..."
        curl -X POST "$VERCEL_DEPLOY_HOOK"
        echo "Vercel deploy hook triggered successfully"
  only:
    - main
  when: manual
  allow_failure: false
