stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HUB_IMAGE: "$DOCKER_HUB_USERNAME/task-manager"
  DOCKER_TAG: "latest"

before_script:
  - echo "Pipeline starting..."

# -------------------------
# 1) BUILD & PUSH TO DOCKER HUB
# -------------------------
build_app:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to Docker Hub (skipped if creds missing)..."
    - |
      if [ -n "$DOCKER_HUB_USERNAME" ] && [ -n "$DOCKER_HUB_PASSWORD" ]; then
        echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
        echo "Building Docker image..."
        docker build -t "$DOCKER_HUB_IMAGE:$DOCKER_TAG" .
        echo "Pushing image to Docker Hub..."
        docker push "$DOCKER_HUB_IMAGE:$DOCKER_TAG"
        echo "Success - Image pushed to Docker Hub"
      else
        echo "Docker Hub credentials not set; skipping build/push but marking job as success."
      fi
  only:
    - develop
    - main
  allow_failure: true

# -------------------------
# 2) RUN TESTS
# -------------------------
test_app:
  stage: test
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Running tests..."
    - npm test
    - echo "Tests completed"
  artifacts:
    expire_in: 1 week
    paths:
      - coverage/
  only:
    - merge_requests
    - develop
  allow_failure: true

# -------------------------
# 3) DEPLOY TO RAILWAY
# -------------------------
deploy_railway:
  stage: deploy
  image: node:18-alpine
  before_script:
    - apk add --no-cache curl bash git
    - npm install -g @railway/cli
  script:
    - echo "Deploying to Railway..."
    - |
      if [ -n "$RAILWAY_TOKEN" ]; then
        export RAILWAY_TOKEN=$RAILWAY_TOKEN
        railway link $RAILWAY_PROJECT_ID
        railway up --detach
        echo "Deployment to Railway completed successfully"
        echo "Your app is available at: https://your-app.up.railway.app"
      else
        echo "Railway token not configured"
        echo "Steps to deploy:"
        echo "1. Install Railway CLI: npm install -g @railway/cli"
        echo "2. Login: railway login"
        echo "3. Get token: railway whoami --token"
        echo "4. Add RAILWAY_TOKEN to GitLab CI/CD Variables"
        exit 1
      fi
  environment:
    name: production
    url: https://your-app.up.railway.app
  only:
    - main
  when: manual
  allow_failure: false
